#!/usr/bin/env ruby

require 'optparse'
require 'active_support'
require 'active_support/core_ext'
require 'rake'

@options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: zwr new PROJECT_NAME [options]"
  opts.separator ""
  opts.separator "Specific options:"

  opts.on("-v", "--[no-]verbose", "Run verbosely, will print really a lot of output") do |v|
    @options[:verbose] = v
  end
  
  @options[:bundle] = true
  opts.on("--skip-bundle", %(Skip bundle install. This will speed up execution, but wil not 
                                     install missing gems. Useful only for debugging templates.)) do |v|
    @options[:bundle] = not(v)
  end
  
  @options[:activerecord] = true
  opts.on("--skip-active-record", %(Skip activerecord. Use this if you will use Mongo.)) do |v|
    @options[:activerecord] = not(v)
  end

  opts.on("-r", "--ruby RUBY_VER",
          "Set ruby version in .rvmrc") do |ruby_ver|
    @options[:ruby_ver] = ruby_ver
  end

  @options[:mongoid] = false
  opts.on("--mongoid",
          "Use MongoDB with Mongoid gem") do |v|
    @options[:mongoid] = v
    if @options[:mongoid]
      @options[:activerecord] = false
    end
  end
end.parse!

def putsv txt
  puts txt.to_s if @options[:verbose]
end

putsv "Using options: #{@options}"
putsv "Executing command: #{ARGV}"

def show_usage
  puts "Usage:"
  puts ""
  puts "  zwr [new|deploy] app_name [options]"
end

case ARGV[0]
when 'new'
  if ARGV.length < 2
    puts "Not enough parameters"
    puts ""
    show_usage
  elsif `git status 2>&1` != "fatal: Not a git repository (or any of the parent directories): .git\n"
    puts "You are in a git repo, and that is not good!"
  else
    puts "creating and initializing new app #{ARGV[1]}"
    putsv `rails new #{ARGV[1]} --skip-bundle #{"--skip-active-record" if not @options[:activerecord]}`
    
    Dir.chdir ARGV[1]
    putsv "Gemfile as we like it!"

    `echo "gem 'zwr'" >> Gemfile`
    `sed '/turbolinks/d' -i Gemfile`
    `sed "s/# gem 'theruby/gem 'theruby/" -i Gemfile`

    `echo "gem 'bootstrap-sass', '~> 3.2.0'" >> Gemfile`
    #`echo "gem 'autoprefixer-rails', '~> 3.2.0'" >> Gemfile`

    `echo "gem 'puma', platforms: :ruby" >> Gemfile`
    `echo "gem 'haml-rails'" >> Gemfile`
    `echo "gem 'angularjs-rails'" >> Gemfile`
    `echo "gem 'angular-rails-templates'" >> Gemfile`
    `echo "gem 'angular-ui-bootstrap-rails'" >> Gemfile`
    `echo "# following should solve the CSRF token with angular" >> Gemfile`
    `echo "gem 'angular_rails_csrf'" >> Gemfile`
    `echo "gem 'devise', '~> 3.3.0'" >> Gemfile`
    `echo "gem 'redcarpet'" >> Gemfile`
    `echo "gem 'paperclip', '~> 4.2'" >> Gemfile`
    `echo "gem 'html2haml'" >> Gemfile`
    
    # Following are for Mongo only, will add it later
    if @options[:mongoid]
      `echo "gem 'mongoid', '~> 4.0.0',github: 'mongoid/mongoid'" >> Gemfile`
      `echo "gem 'bson_ext'" >> Gemfile`
    end
    
    `echo "gem 'factory_girl_rails', '~> 4.0'" >> Gemfile`
    
    `echo "gem 'tzinfo-data', platforms: [:mingw, :mswin, :x64_mingw]" >> Gemfile`
    `echo "gem 'tzinfo', platforms: [:mingw, :mswin, :x64_mingw]" >> Gemfile`

    putsv "README as we like it!"
    putsv `rm README.rdoc`
    `echo "Application #{ARGV[1]} generated bu the zwr generator." > README.markdown`

    if @options[:bundle]
      putsv "bundling up... This may take a few minutes..."
      putsv `bundle install`
    end
    putsv "zwring..."
    putsv `rake zwr:install`
    if @options[:ruby_ver]
      putsv "creating .ruby-version"
      `rvm --ruby-version use #{@options[:ruby_ver]} >> .ruby-version`
    end
    if @options[:mongoid]
      putsv "configuration for mongoid"
      `rails g mongoid:config`
    end
    putsv "database generation"
    putsv `rake db:migrate`
    putsv "praxing"
    putsv `prax link`
    putsv `prax start`
    putsv "git it up"
    putsv `git init`
    putsv `git add -A`
    putsv `git commit -sm "initial commit - zwr new #{ARGV[1]}"`
    putsv `git remote add origin git@github.com:zmilojko/#{ARGV[1]}.git`
    puts "Completed. If there was no errors above, you should be good to go!"
    puts "In your browser, open http://#{ARGV[1]}.dev"
  end

when 'deploy'
  if ARGV.length < 2
    puts "Not enough parameters"
    puts ""
    show_usage
  elsif ENV['USER'] != "root"
    puts "This script must be run as super user. Use sudo zwr deploy #{ARGV[2]}"
  else
    if File.directory? "/var/rails_apps/#{ARGV[1]}"
      putsv "Updating existing #{ARGV[1]}"
      Dir.chdir "/var/rails_apps/#{ARGV[1]}"
      `cd /var/rails_apps/#{ARGV[1]} ; git fetch`
      `cd /var/rails_apps/#{ARGV[1]} ; git checkout production`
      `cd /var/rails_apps/#{ARGV[1]} ; git reset --hard origin/production`
    else
      Dir.chdir "/var/rails_apps"
      putsv "Deploying new project #{ARGV[1]}"
      `git clone git@github.com:zmilojko/#{ARGV[1]}.git`
      Dir.chdir "/var/rails_apps/#{ARGV[1]}"
      `cd /var/rails_apps/#{ARGV[1]} ; git checkout production`
      `bundle install`
      `cd /var/rails_apps/#{ARGV[1]} ; RAILS_ENV=production rake db:migrate`
      `cd /var/rails_apps/#{ARGV[1]} ; RAILS_ENV=production rake db:seed`
      `mkdir /var/rails_apps/#{ARGV[1]}/tmp`
      `chmod 777 /var/rails_apps/#{ARGV[1]}/tmp -R`
      `chmod 777 /var/rails_apps/#{ARGV[1]}/log`
      `chmod 777 /var/rails_apps/#{ARGV[1]}/db`
      `chmod 777 /var/rails_apps/#{ARGV[1]}/db/production.sqlite3`
      virtual_host_file = (<<-VHFILE.strip_heredoc)
      <VirtualHost *:80>
          # This Rails web app will use Ruby 1.9.3, as installed by RVM
          PassengerRuby /usr/local/rvm/wrappers/ruby-1.9.3-p0/ruby
          ServerName #{ARGV[1]}.zwr.fi
          DocumentRoot /var/rails_apps/#{ARGV[1]}/public
          <Directory /var/rails_apps/#{ARGV[1]}/public>
            AllowOverride all
            Options -MultiViews
          </Directory>
      </VirtualHost>
      VHFILE
      `echo "#{virtual_host_file}" > /etc/httpd/virtual_hosts/#{ARGV[1]}.conf`
      `service httpd reload`
    end
    `touch /var/rails_apps/#{ARGV[1]}/tmp/restart.txt`
  end
else
  show_usage
end
